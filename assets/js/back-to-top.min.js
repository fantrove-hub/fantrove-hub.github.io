document.addEventListener('DOMContentLoaded', () => {
 const LANGUAGES = {
  th: {
   backToTop: '↑'
  },
  en: {
   backToTop: '↑'
  }
 };
 
 const SETTINGS = {
  SCROLL_THRESHOLD: 80, // ระยะที่ต้องเลื่อนลงก่อนแสดงปุ่ม (px)
  FADE_DURATION: 300, // ระยะเวลาของ fade animation (ms)
  INACTIVITY_TIMEOUT: 300, // ระยะเวลาที่ต้องหยุดก่อนแสดงปุ่ม (ms)
  BOTTOM_OFFSET: 70, // ระยะห่างจากด้านล่างของหน้าจอ (px)
  SAFE_ZONE: 50, // ระยะปลอดภัยที่ไม่ต้องแสดงปุ่ม (px)
  SLOW_SCROLL_SPEED: 0.2, // ความเร็วเลื่อนขึ้นที่ถือว่าช้า (px/ms)
  FAST_SCROLL_SPEED: 1.5, // ความเร็วเลื่อนขึ้นที่ถือว่าเร็ว (px/ms)
  MIN_SCROLL_DELTA: 3, // ระยะเลื่อนลงขั้นต่ำก่อนซ่อนปุ่ม (px)
  MIN_SLOW_SCROLL_DURATION: 300 // ระยะเวลาขั้นต่ำที่เลื่อนช้าก่อนซ่อนปุ่ม (ms)
 };
 
 const state = {
  isButtonVisible: false,
  isAnimating: false,
  lastScrollY: 0,
  lastScrollTime: Date.now(),
  slowScrollStartTime: null, // เวลาเริ่มต้นของการเลื่อนแบบช้า
  inactivityTimeout: null,
  delayTimeout: null
 };
 
 const createBackToTopButton = () => {
  const button = document.createElement('button');
  button.id = 'back-to-top';
  button.className = 'back-to-top hidden';
  button.textContent = getLocalizedText('backToTop');
  
  button.addEventListener('click', () => {
   scrollToTop();
   triggerVibration(); // เรียกใช้การสั่นของอุปกรณ์
  });
  
  document.body.appendChild(button);
  
  applyStyles();
  return button;
 };
 
 const applyStyles = () => {
  const style = document.createElement('style');
  style.textContent = `
            #back-to-top {
                position: fixed;
                bottom: ${SETTINGS.BOTTOM_OFFSET}px;
                right: 20px;
                width: 40px;
                height: 40px;
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                color: white;
                font-size: 1.5rem;
                font-weight: bold;
                border: none;
                border-radius: 50%;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                cursor: pointer;
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: opacity ${SETTINGS.FADE_DURATION}ms ease, visibility ${SETTINGS.FADE_DURATION}ms ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #back-to-top.visible {
                opacity: 1;
                visibility: visible;
            }

            #back-to-top.hidden {
                opacity: 0;
                visibility: hidden;
            }

            #back-to-top:focus {
                outline: none;
            }
        `;
  document.head.appendChild(style);
 };
 
 const getLocalizedText = (key) => {
  const lang = localStorage.getItem('selectedLang') || 'en';
  return LANGUAGES[lang]?.[key] || LANGUAGES['en'][key];
 };
 
 const scrollToTop = () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
 };
 
 const triggerVibration = () => {
  if ("vibrate" in navigator) {
   navigator.vibrate(50); // สั่นเป็นเวลา 50 มิลลิวินาที
  }
 };
 
 const calculateScrollSpeed = () => {
  const now = Date.now();
  const timeDiff = now - state.lastScrollTime;
  const scrollDiff = Math.abs(window.scrollY - state.lastScrollY);
  const speed = timeDiff > 0 ? scrollDiff / timeDiff : 0;
  
  state.lastScrollTime = now;
  return speed;
 };
 
 const handleScroll = () => {
  const scrollY = window.scrollY;
  const scrollSpeed = calculateScrollSpeed();
  
  clearTimeout(state.inactivityTimeout);
  clearTimeout(state.delayTimeout);
  
  // ซ่อนปุ่มเมื่ออยู่ใน Safe Zone (ระยะปลอดภัย)
  if (scrollY <= SETTINGS.SAFE_ZONE) {
   hideButton();
   return;
  }
  
  // แสดงปุ่มทันทีเมื่อเลื่อนขึ้นเร็ว
  if (scrollY < state.lastScrollY && scrollSpeed >= SETTINGS.FAST_SCROLL_SPEED) {
   showButton();
   state.slowScrollStartTime = null; // รีเซ็ตเวลาเริ่มต้นของการเลื่อนช้า
   return;
  }
  
  // ตรวจจับการเลื่อนช้า
  if (scrollY < state.lastScrollY && scrollSpeed < SETTINGS.SLOW_SCROLL_SPEED) {
   // ตั้งค่าเวลาเริ่มต้นของการเลื่อนช้า
   if (!state.slowScrollStartTime) {
    state.slowScrollStartTime = Date.now();
   }
   
   // ตรวจสอบว่าการเลื่อนช้าต่อเนื่องเกินระยะเวลาที่กำหนดหรือไม่
   const slowScrollDuration = Date.now() - state.slowScrollStartTime;
   if (slowScrollDuration >= SETTINGS.MIN_SLOW_SCROLL_DURATION) {
    hideButton();
    return;
   }
  } else {
   // รีเซ็ตเวลาเริ่มต้นเมื่อความเร็วไม่ถือว่าช้า
   state.slowScrollStartTime = null;
  }
  
  // ตั้งเวลาแสดงปุ่มเมื่อหยุดเลื่อน
  state.inactivityTimeout = setTimeout(() => {
   if (Math.abs(scrollY - state.lastScrollY) < 5 && scrollY > SETTINGS.SCROLL_THRESHOLD) {
    state.delayTimeout = setTimeout(() => {
     showButton();
    }, SETTINGS.INACTIVITY_TIMEOUT); // รอ 1 วินาที
   }
  }, SETTINGS.INACTIVITY_TIMEOUT);
  
  // ซ่อนปุ่มเมื่อเลื่อนลงต่อและระยะเลื่อนเกิน 10px
  if (scrollY > state.lastScrollY && (scrollY - state.lastScrollY) >= SETTINGS.MIN_SCROLL_DELTA) {
   hideButton();
  }
  
  state.lastScrollY = scrollY;
 };
 
 const showButton = () => {
  if (state.isButtonVisible || state.isAnimating) return;
  
  const button = document.getElementById('back-to-top');
  button.classList.remove('hidden');
  button.classList.add('visible');
  state.isButtonVisible = true;
 };
 
 const hideButton = () => {
  if (!state.isButtonVisible || state.isAnimating) return;
  
  const button = document.getElementById('back-to-top');
  button.classList.remove('visible');
  button.classList.add('hidden');
  state.isButtonVisible = false;
 };
 
 const setupLanguageChangeListener = () => {
  window.addEventListener('languageChange', () => {
   const button = document.getElementById('back-to-top');
   if (button) {
    button.textContent = getLocalizedText('backToTop');
   }
  });
 };
 
 const backToTopButton = createBackToTopButton();
 setupLanguageChangeListener();
 
 window.addEventListener('scroll', handleScroll, { passive: true });
});