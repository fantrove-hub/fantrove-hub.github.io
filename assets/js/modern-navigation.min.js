/**
 * ModernNavigation - ระบบจัดการการนำทางสมัยใหม่แบบหลายภาษา
 * @class
 */
class ModernNavigation {
 /**
  * @constructor
  * @param {Object} config - ค่า config เริ่มต้น
  */
 constructor(config = {}) {
  // ค่าเริ่มต้นพื้นฐาน
  this.cssPath = config.cssPath || '/assets/css/modern-styles.min.css';
  this.configPath = config.configPath || '/assets/json/buttons.min.json';
  this.activeClass = config.activeClass || 'actives';
  this.navItemSelector = config.navItemSelector || '.nav-item';
  
  // Template HTML สำหรับ Navigation
  this.template = `
      <div class="bottom-nav">
        <!-- Navigation items จะถูกเพิ่มที่นี่โดย JavaScript -->
      </div>
    `;
  
  // Template HTML สำหรับปุ่มนำทาง
  this.buttonTemplate = `
      <button class="nav-item" data-link="{link}">
        {icon}
        <div class="label">{label}</div>
      </button>
    `;
  
  // ค่าเริ่มต้นสำหรับการจัดการภาษา
  this.defaultLang = 'en';
  this.currentLang = localStorage.getItem('selectedLang') || this.defaultLang;
  
  // เก็บ cache ของข้อมูลการนำทาง
  this.navigationCache = new Map();
  
  // เก็บ reference ของ event listeners และ original functions
  this._boundClickHandler = this._handleClick.bind(this);
  this._boundScrollHandler = this._handleScroll.bind(this);
  this._boundLangChangeHandler = this._handleLanguageChange.bind(this);
  this._boundStorageHandler = this._handleStorageChange.bind(this);
  this._originalSetItem = localStorage.setItem;
  
  // สถานะการทำงาน
  this._initialized = false;
  this._eventsBound = false;
  this._config = null;
 }
 
 /**
  * เริ่มต้นการทำงานของระบบนำทาง
  * @returns {Promise<void>}
  */
 async init() {
  try {
   if (this._initialized) {
    console.warn('ModernNavigation ถูก initialize แล้ว');
    return;
   }
   
   await Promise.all([
    this._loadCSS(),
    this._loadConfig()
   ]);
   
   this._injectNavigation();
   this._setupNavigation();
   this._updateActiveState();
   this._setupLanguageListener();
   this._setupStorageListener();
   this._initialized = true;
   
  } catch (error) {
   console.error('เกิดข้อผิดพลาดในการ initialize ModernNavigation:', error);
   this._cleanup();
   throw error;
  }
 }
 
 /**
  * แทรก Navigation HTML เข้าไปในหน้าเว็บ
  * @private
  */
 _injectNavigation() {
  const navigationElement = document.createElement('div');
  navigationElement.innerHTML = this.template.trim();
  document.body.appendChild(navigationElement.firstChild);
  this._createNavigationItems();
 }
 
 /**
  * สร้างปุ่มนำทางจาก template และ config
  * @private
  */
 _createNavigationItems() {
  const navContainer = document.querySelector('.bottom-nav');
  if (!navContainer || !this._config?.navigation) return;
  
  navContainer.innerHTML = this._config.navigation.map(item => {
   return this.buttonTemplate
    .replace('{link}', item.url)
    .replace('{icon}', item.icon || '')
    .replace('{label}', item[`${this.currentLang}_label`] || item.en_label || 'Missing Label');
  }).join('');
 }
 
 /**
  * โหลดไฟล์ config สำหรับการนำทาง
  * @private
  * @returns {Promise<void>}
  */
 async _loadConfig() {
  try {
   const cached = this.navigationCache.get('config');
   if (cached && Date.now() - cached.timestamp < 300000) {
    this._config = cached.data;
    return;
   }
   
   const response = await fetch(this.configPath);
   if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
   
   this._config = await response.json();
   
   this.navigationCache.set('config', {
    data: this._config,
    timestamp: Date.now()
   });
   
  } catch (error) {
   console.error('ไม่สามารถโหลด navigation config:', error);
   throw error;
  }
 }
 
 /**
  * อัปเดต labels ตามภาษาที่เลือก
  * @private
  */
 _updateLabels() {
  document.querySelectorAll(this.navItemSelector).forEach(item => {
   const labelElement = item.querySelector('.label');
   if (!labelElement) return;
   
   const itemLink = item.dataset.link;
   const configItem = this._config?.navigation.find(nav => nav.url === itemLink);
   if (!configItem) return;
   
   labelElement.textContent = configItem[`${this.currentLang}_label`] ||
    configItem.en_label ||
    'Missing Label';
  });
 }

 /**
  * อัปเดตภาษาของระบบ
  * @param {string} newLanguage - รหัสภาษาใหม่ (เช่น 'th', 'en')
  * @private
  */
 _updateLanguage(newLanguage) {
  if (newLanguage && newLanguage !== this.currentLang) {
   console.log(`กำลังเปลี่ยนภาษาเป็น: ${newLanguage}`);
   this.currentLang = newLanguage;
   this._updateLabels();
  }
 }
 
 /**
  * จัดการการคลิกที่รายการนำทาง
  * @private
  * @param {Event} event
  */
 _handleClick(event) {
  const item = event.currentTarget;
  const targetLink = item.dataset.link;
  
  if (targetLink && !item.classList.contains(this.activeClass)) {
   if (window.location.pathname.endsWith(targetLink)) return;
   window.location.href = targetLink;
  }
 }
 
 /**
  * จัดการ scroll event
  * @private
  */
 _handleScroll() {
  if (!this._scrollTimeout) {
   this._scrollTimeout = window.requestAnimationFrame(() => {
    this._updateActiveState();
    this._scrollTimeout = null;
   });
  }
 }
 
 /**
  * จัดการการเปลี่ยนแปลงใน localStorage
  * @private
  * @param {StorageEvent} event
  */
 _handleStorageChange(event) {
  if (event.key === 'selectedLang') {
   this._updateLanguage(event.newValue);
  }
 }
 
 /**
  * อัพเดทสถานะ active ของรายการนำทาง
  * @private
  */
 _updateActiveState() {
  const currentPath = window.location.pathname;
  document.querySelectorAll(this.navItemSelector).forEach(item => {
   const navLink = item.dataset.link;
   if (navLink === '/' || navLink === '/index.html') {
    item.classList.toggle(this.activeClass, currentPath === '/' || currentPath.endsWith('/index.html'));
   } else {
    const normalizedNavLink = navLink.endsWith('/') ? navLink : navLink + '/';
    item.classList.toggle(this.activeClass, currentPath.startsWith(normalizedNavLink));
   }
  });
 }
 
 /**
  * จัดการการเปลี่ยนภาษา
  * @private
  * @param {CustomEvent} event
  */
 _handleLanguageChange(event) {
  this.currentLang = event.detail.language;
  this._updateLabels();
 }
 
 /**
  * ตั้งค่า event listeners
  * @private
  */
 _setupNavigation() {
  if (this._eventsBound) return;
  
  document.querySelectorAll(this.navItemSelector).forEach(item => {
   item.addEventListener('click', this._boundClickHandler);
  });
  
  window.addEventListener('scroll', this._boundScrollHandler, { passive: true });
  this._eventsBound = true;
 }
 
 /**
  * ตั้งค่า event listener สำหรับการเปลี่ยนภาษา
  * @private
  */
 _setupLanguageListener() {
  window.addEventListener('languageChange', this._boundLangChangeHandler);
 }

 /**
  * ตั้งค่า event listener สำหรับการติดตามการเปลี่ยนแปลงใน localStorage
  * @private
  */
 _setupStorageListener() {
  // ติดตามการเปลี่ยนแปลงจาก tab อื่น
  window.addEventListener('storage', this._boundStorageHandler);

  // Override localStorage.setItem เพื่อดักจับการเปลี่ยนแปลงในแท็บปัจจุบัน
  localStorage.setItem = (key, value) => {
   this._originalSetItem.call(localStorage, key, value);
   if (key === 'selectedLang') {
    this._updateLanguage(value);
   }
  };
 }
 
 /**
  * โหลด CSS สำหรับการนำทาง
  * @private
  * @returns {Promise<void>}
  */
 async _loadCSS() {
  return new Promise((resolve, reject) => {
   if (document.querySelector(`link[href="${this.cssPath}"]`)) {
    resolve();
    return;
   }
   
   const link = document.createElement('link');
   link.rel = 'stylesheet';
   link.href = this.cssPath;
   
   link.onload = () => resolve();
   link.onerror = () => reject(new Error(`ไม่สามารถโหลด CSS: ${this.cssPath}`));
   
   document.head.appendChild(link);
  });
 }
 
 /**
  * ทำความสะอาด resources และ event listeners
  * @private
  */
 _cleanup() {
  if (this._eventsBound) {
   document.querySelectorAll(this.navItemSelector).forEach(item => {
    item.removeEventListener('click', this._boundClickHandler);
   });
   
   window.removeEventListener('scroll', this._boundScrollHandler);
   window.removeEventListener('languageChange', this._boundLangChangeHandler);
   window.removeEventListener('storage', this._boundStorageHandler);
   
   // คืนค่า original setItem
   localStorage.setItem = this._originalSetItem;
   
   if (this._scrollTimeout) {
    window.cancelAnimationFrame(this._scrollTimeout);
    this._scrollTimeout = null;
   }
   
   this._eventsBound = false;
  }
 }
 
 /**
  * ยกเลิกการทำงานของ ModernNavigation
  * @public
  */
 destroy() {
  this._cleanup();
  this._initialized = false;
 }
}

// Initialize เมื่อ DOM พร้อม
document.addEventListener('DOMContentLoaded', () => {
 const navigation = new ModernNavigation({
  cssPath: '/assets/css/modern-styles.min.css',
  configPath: '/assets/json/template/template.min.json',
 });
 
 navigation.init().catch(error => {
  console.error('เกิดข้อผิดพลาดในการ initialize navigation:', error);
 });
});